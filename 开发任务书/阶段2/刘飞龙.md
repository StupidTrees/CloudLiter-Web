# 任务名称：完成好友系统
##### 负责人：刘飞龙
##### 任务截止：2020/10/08 24:00
#### 注意事项 每完成一项功能就push一次

### 用户故事
- 用户A在搜索到某用户B后（得知了B的id），向B提出添加好友申请
- B可以在联系人页面查询到发给自己的所有申请，并可以选中任意一个申请，进行同意或拒绝
- 服务器收到B的同意后，建立A和B的**双向**好友关系，同时开启一个A和B的会话
- 若申请被拒绝，A将在联系人页面查看到被拒绝的消息
- A和B大吵一架，A决定删除B的好友，此时A和B的好友关系**双向**同时解除，并且B同样会**在联系人页面收到A删除自己的消息**
### 功能需求及接口规定
#### 1. 创建好友申请
- [x] 完成
- 功能描述：在relationEvent表中插入一行userId->friendId的好友申请
- 注意：**如果relationEvent中已存在friendId->userId的申请，那么不执行插入，而是执行“接受好友申请”（见功能2）***
- 接口地址：/relation/event/request
- 请求方式：POST
- 请求参数

    | 参数 | 含义 | 示例 |
    | ---- | ---- | ---- |
    | userId(可选) | 发出请求的用户id | 2 |
    | friendId| 目标用户id| 4|
    
#### 2. 接受或拒绝好友申请
- [x] 完成
- 功能描述：根据好友申请的id，在relationEvent表中找到对应的那行，标记为同意/拒绝
  若同意，则在Relation表中加入双向关系，同时在Conversation表中插入对话
- 接口地址：/relation/event/response
- 请求方式：POST
- 请求参数

    | 参数 | 含义 | 示例 |
    | ---- | ---- | ---- |
    | eventId | 好友申请的id | 4-2 |
    | action| 回应| 接受ACCEPT，拒绝REJECT|

- 异常处理：eventId对应的行不存在

#### 3. 查询所有发给自己的好友请求
- [x] 完成
- 功能描述：根据用户id，在relationEvent表中找到发给该id，并且状态为“请求中”的所有行
- 接口地址：/relation/event/query_unread
- 请求方式：GET
- 请求参数

    | 参数 | 含义 | 示例 |
    | ---- | ---- | ---- |
    | userId(可选) | 我的id | 2 |
    
- 返回格式
    data字段为JsonArray格式，其中每一项为和relationEvent表对应的JsonObject

#### 4. 计数所有发给自己的好友请求
- [x] 完成
- 功能描述：根据用户id，在relationEvent表中计数发给该id，并且状态为“申请中”的所有行
- 接口地址：/relation/event/count_unread
- 请求方式：GET
- 请求参数

    | 参数 | 含义 | 示例 |
    | ---- | ---- | ---- |
    | userId(可选) | 我的id | 2 |
    
- 返回格式  
    data字段为数值

#### 5. 查询所有和自己有关的好友请求事件
- [ ] 完成
- 功能描述：根据用户id，在relationEvent表中找到该id发出的，或发给该id的行
- 接口地址：/relation/event/query_mine
- 请求方式：GET
- 请求参数

    | 参数 | 含义 | 示例 |
    | ---- | ---- | ---- |
    | userId(可选) | 我的id | 2 |
    
- 返回格式
    data字段为JsonArray格式，其中每一项为和relationEvent表对应的JsonObject

#### 6. 计数所有自己发出的被拒绝请求
- [ ] 完成
- 功能描述：根据用户id，在relationEvent表中计数该id发出的，所有状态为“被拒绝”的行
- 接口地址：/relation/event/query_rejected
- 请求方式：GET
- 请求参数

    | 参数 | 含义 | 示例 |
    | ---- | ---- | ---- |
    | userId(可选) | 我的id | 2 |
    
- 返回格式
    data字段为数值
    
#### 7. 删除好友
- [ ] 完成
- 功能描述：根据用户id和好友id，删除他们的双向关系，**并在relationEvent表中新建状态为“删除好友”的一行**，（用户id->好友id）
- 接口地址：/relation/event/query_rejected
- 请求方式：POST
- 请求参数

    | 参数 | 含义 | 示例 |
    | ---- | ---- | ---- |
    | userId(可选) | 我的id | 2 |
    
- 返回格式
    data字段为数值
    
#### 8. 计数所有自己被删的事件
- [ ] 完成
- 功能描述：根据用户id，在relationEvent表中计数发给该id的，所有状态为“删除好友”的行
- 接口地址：/relation/event/query_rejected
- 请求方式：GET
- 请求参数

    | 参数 | 含义 | 示例 |
    | ---- | ---- | ---- |
    | userId(可选) | 我的id | 2 |
    
- 返回格式
    data字段为数值
    
### 功能实现指南
#### 1. 新建relationEvent表
   该表至少需包含如下几列，且必须按说明设置主键和外键
   
   | 字段 | 类型 | 含义 | 示例| 说明|
   | ---- | ---- | ---- | ---- | ---- |
   | key | string | 主键 | 1-3表示1向3发送的请求|主键|
   | userId| bigint| 用户1id|1| 链接到User表"id"字段的外键|
   |friendId|bigint|用户2id|3|链接到User表"id"字段的外键|
   |state|enum|状态|REQUESTING请求中<br>ACCEPTED被接受<br>REJECTED被拒绝<br>DELETE删好友|非空|
   |createdAt|date|创建时间|||
   |updatedAt|date|更新时间|||
       
#### 2. 需要变动的文件
- database/models
- repository/userRelationRepository
- app

#### 3. 需要新建的文件
- repository/relationEventRepository
- service/relationEventService
- routes/relationEvent
    
